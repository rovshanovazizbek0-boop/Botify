{% extends "base.html" %}

{% block title %}{{ t.profile }} - BotFactory{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-4 mb-4">
            <!-- Profile Card -->
            <div class="card">
                <div class="card-body text-center">
                    <div class="profile-avatar mb-3">
                        <img src="https://ui-avatars.com/api/?name={{ current_user.username }}&size=100&background=007bff&color=fff" 
                             alt="{{ current_user.username }}" class="rounded-circle" width="100" height="100">
                    </div>
                    <h4 class="mb-1">{{ current_user.username }}</h4>
                    <p class="text-muted mb-3">{{ current_user.email }}</p>
                    
                    <!-- Subscription Status -->
                    <div class="subscription-status mb-3">
                        <span class="badge badge-subscription 
                            {% if current_user.subscription_type.value == 'free' %}bg-secondary
                            {% elif current_user.subscription_type.value == 'business' %}bg-primary
                            {% else %}bg-warning{% endif %}">
                            {{ current_user.subscription_type.value.title() }}
                            {% if current_user.is_trial %}(Trial){% endif %}
                        </span>
                        
                        {% if current_user.is_subscription_active() %}
                        <div class="subscription-info mt-2">
                            <small class="text-muted">
                                {% if current_user.days_until_expiry() > 0 %}
                                {{ current_user.days_until_expiry() }} days remaining
                                {% else %}
                                Expires today
                                {% endif %}
                            </small>
                        </div>
                        {% else %}
                        <div class="subscription-info mt-2">
                            <small class="text-danger">Expired</small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="profile-stats">
                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="mb-0">{{ current_user.bots|length }}</h5>
                                <small class="text-muted">Bots</small>
                            </div>
                            <div class="col-4">
                                <h5 class="mb-0">{{ current_user.conversations|length }}</h5>
                                <small class="text-muted">Chats</small>
                            </div>
                            <div class="col-4">
                                <h5 class="mb-0">{{ (current_user.created_at.now() - current_user.created_at).days }}</h5>
                                <small class="text-muted">Days</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        {% if not current_user.is_subscription_active() or current_user.days_until_expiry() <= 3 %}
                        <a href="#" class="btn btn-primary btn-sm">
                            <i class="fas fa-crown me-2"></i>{{ t.upgrade_subscription }}
                        </a>
                        {% endif %}
                        <a href="{{ url_for('dashboard.bot_create') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-plus me-2"></i>{{ t.create_bot }}
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadData()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteAccount()">
                            <i class="fas fa-trash me-2"></i>Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <!-- Profile Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Profile Settings</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">{{ t.username }}</label>
                                {{ form.username(class="form-control") }}
                                {% for error in form.username.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">{{ t.email }}</label>
                                {{ form.email(class="form-control") }}
                                {% for error in form.email.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="language" class="form-label">{{ t.language }}</label>
                            {{ form.language(class="form-select") }}
                            {% for error in form.language.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Account Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Account Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="form-label text-muted">Member Since</label>
                                <p class="mb-0">{{ current_user.created_at.strftime('%B %d, %Y') }}</p>
                            </div>
                            
                            <div class="info-item mb-3">
                                <label class="form-label text-muted">Last Login</label>
                                <p class="mb-0">
                                    {% if current_user.last_login %}
                                    {{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') }}
                                    {% else %}
                                    Never logged in before
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="form-label text-muted">Subscription Type</label>
                                <p class="mb-0">
                                    {{ current_user.subscription_type.value.title() }}
                                    {% if current_user.is_trial %}
                                    <span class="badge bg-info ms-2">Trial</span>
                                    {% endif %}
                                </p>
                            </div>
                            
                            <div class="info-item mb-3">
                                <label class="form-label text-muted">Subscription Status</label>
                                <p class="mb-0">
                                    {% if current_user.is_subscription_active() %}
                                    <span class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>Active
                                        ({{ current_user.days_until_expiry() }} days remaining)
                                    </span>
                                    {% else %}
                                    <span class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>Expired
                                    </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Security Settings</h5>
                </div>
                <div class="card-body">
                    <div class="security-item d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">Change Password</h6>
                            <small class="text-muted">Update your account password</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="showPasswordModal()">
                            <i class="fas fa-key me-2"></i>Change
                        </button>
                    </div>
                    
                    <div class="security-item d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">Two-Factor Authentication</h6>
                            <small class="text-muted">Add extra security to your account</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="twoFactorToggle">
                            <label class="form-check-label" for="twoFactorToggle">
                                <span class="badge bg-secondary">Coming Soon</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="security-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Login Notifications</h6>
                            <small class="text-muted">Get notified of new login attempts</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="loginNotifications" checked>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Statistics -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Usage Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="usage-stat">
                                <h4 class="text-primary mb-1">{{ current_user.bots|length }}</h4>
                                <p class="mb-0 small">
                                    {% if current_user.subscription_type.value == 'free' %}
                                    of 1 bots
                                    {% elif current_user.subscription_type.value == 'business' %}
                                    of 20 bots
                                    {% else %}
                                    bots (unlimited)
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="usage-stat">
                                <h4 class="text-success mb-1">0</h4>
                                <p class="mb-0 small">
                                    {% if current_user.subscription_type.value == 'free' %}
                                    of 100 daily messages
                                    {% else %}
                                    messages (unlimited)
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="usage-stat">
                                <h4 class="text-info mb-1">{{ current_user.conversations|length }}</h4>
                                <p class="mb-0 small">total conversations</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="usage-stat">
                                <h4 class="text-warning mb-1">99.8%</h4>
                                <p class="mb-0 small">uptime</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if current_user.subscription_type.value == 'free' %}
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: {{ (current_user.bots|length / 1) * 100 }}%"></div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">Bot usage: {{ current_user.bots|length }}/1</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">Password must be at least 6 characters long</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showPasswordModal() {
    const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
    modal.show();
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill in all fields');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }
    
    // Here you would send the password change request to the server
    alert('Password change functionality would be implemented here');
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
    modal.hide();
}

function downloadData() {
    // Export user data functionality
    alert('Data export functionality would be implemented here');
}

function confirmDeleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone and will delete all your bots and data.')) {
        if (confirm('This is permanent. Are you absolutely sure?')) {
            alert('Account deletion functionality would be implemented here');
        }
    }
}

// Login notifications toggle
document.getElementById('loginNotifications').addEventListener('change', function() {
    const enabled = this.checked;
    // Update setting on server
    console.log('Login notifications:', enabled ? 'enabled' : 'disabled');
});
</script>
{% endblock %}
