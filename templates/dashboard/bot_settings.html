{% extends "base.html" %}

{% block title %}{{ bot.name }} Settings - BotFactory{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Navigation Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="bot-avatar-large mb-2">
                            {% if bot.avatar_url %}
                            <img src="{{ bot.avatar_url }}" alt="{{ bot.name }}" class="rounded-circle" width="80" height="80">
                            {% else %}
                            <div class="avatar-placeholder-lg">
                                <i class="fas fa-robot fa-3x"></i>
                            </div>
                            {% endif %}
                        </div>
                        <h5 class="mb-1">{{ bot.name }}</h5>
                        <span class="badge {% if bot.is_active and bot.telegram_token %}bg-success{% elif bot.is_active %}bg-warning{% else %}bg-secondary{% endif %}">
                            {% if bot.is_active and bot.telegram_token %}{{ t.active }}
                            {% elif bot.is_active %}Not Configured
                            {% else %}{{ t.inactive }}{% endif %}
                        </span>
                    </div>
                    
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link active" href="#general" data-bs-toggle="pill">
                            <i class="fas fa-cog me-2"></i>General Settings
                        </a>
                        <a class="nav-link" href="#telegram" data-bs-toggle="pill">
                            <i class="fab fa-telegram me-2"></i>Telegram Integration
                        </a>
                        <a class="nav-link" href="#ai-config" data-bs-toggle="pill">
                            <i class="fas fa-brain me-2"></i>AI Configuration
                        </a>
                        <a class="nav-link" href="#knowledge-base" data-bs-toggle="pill">
                            <i class="fas fa-book me-2"></i>{{ t.knowledge_base }}
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard.analytics', bot_id=bot.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-chart-line me-2"></i>{{ t.analytics }}
                        </a>
                        <button class="btn btn-outline-success btn-sm" onclick="testBot()">
                            <i class="fas fa-play me-2"></i>Test Bot
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete()">
                            <i class="fas fa-trash me-2"></i>{{ t.delete }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.main') }}">{{ t.dashboard }}</a></li>
                    <li class="breadcrumb-item active">{{ bot.name }}</li>
                </ol>
            </nav>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- General Settings -->
                <div class="tab-pane fade show active" id="general">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">General Settings</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                {{ form.hidden_tag() }}
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">{{ t.bot_name }}</label>
                                            {{ form.name(class="form-control") }}
                                            {% for error in form.name.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="description" class="form-label">{{ t.bot_description }}</label>
                                            {{ form.description(class="form-control", rows="3") }}
                                            {% for error in form.description.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            {{ form.is_active(class="form-check-input") }}
                                            <label for="is_active" class="form-check-label">
                                                Bot is active and can respond to messages
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <label class="form-label">Bot Avatar</label>
                                            <div class="bot-avatar-upload mb-3">
                                                <div class="avatar-placeholder-lg mb-2">
                                                    <i class="fas fa-camera"></i>
                                                </div>
                                                <input type="file" class="form-control form-control-sm" accept="image/*">
                                                <small class="text-muted">Upload avatar image</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Telegram Integration -->
                <div class="tab-pane fade" id="telegram">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Telegram Integration</h5>
                        </div>
                        <div class="card-body">
                            {% if not bot.telegram_token %}
                            <div class="alert alert-info" role="alert">
                                <h6 class="alert-heading">Setup Required</h6>
                                <p class="mb-0">To connect your bot to Telegram, you need to create a bot token from @BotFather.</p>
                            </div>
                            {% endif %}
                            
                            <form method="POST">
                                {{ form.hidden_tag() }}
                                
                                <div class="mb-3">
                                    <label for="telegram_token" class="form-label">{{ t.telegram_token }}</label>
                                    {{ form.telegram_token(class="form-control", placeholder="123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghi") }}
                                    {% for error in form.telegram_token.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                    <div class="form-text">Get your token from @BotFather on Telegram</div>
                                </div>
                                
                                {% if bot.telegram_webhook_url %}
                                <div class="mb-3">
                                    <label class="form-label">Webhook URL</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" value="{{ bot.telegram_webhook_url }}" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyWebhookUrl()">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="form-text text-success">
                                        <i class="fas fa-check me-1"></i>Webhook is configured and active
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-end">
                                    {{ form.submit(class="btn btn-primary", value="Update Telegram Settings") }}
                                </div>
                            </form>
                            
                            <!-- Setup Instructions -->
                            <hr>
                            <h6>How to create a Telegram bot:</h6>
                            <ol class="small text-muted">
                                <li>Open Telegram and search for @BotFather</li>
                                <li>Send /newbot command</li>
                                <li>Follow the instructions to name your bot</li>
                                <li>Copy the token and paste it above</li>
                                <li>Click "Update Telegram Settings" to configure webhook</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- AI Configuration -->
                <div class="tab-pane fade" id="ai-config">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">AI Configuration</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                {{ form.hidden_tag() }}
                                
                                <div class="mb-3">
                                    <label for="system_prompt" class="form-label">{{ t.system_prompt }}</label>
                                    {{ form.system_prompt(class="form-control", rows="5") }}
                                    {% for error in form.system_prompt.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                    <div class="form-text">Define your bot's personality, role, and behavior guidelines</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="temperature" class="form-label">{{ t.temperature }} ({{ form.temperature.data or 0.7 }})</label>
                                            {{ form.temperature(class="form-range", min="0", max="2", step="0.1", oninput="updateTemperatureDisplay(this.value)") }}
                                            {% for error in form.temperature.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                            <div class="form-text" id="temperature-help">Controls response creativity and randomness</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="max_tokens" class="form-label">{{ t.max_tokens }}</label>
                                            {{ form.max_tokens(class="form-control", min="1", max="4000") }}
                                            {% for error in form.max_tokens.errors %}
                                                <div class="text-danger small">{{ error }}</div>
                                            {% endfor %}
                                            <div class="form-text">Maximum length of bot responses</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Model Selection (for Enterprise users) -->
                                {% if current_user.subscription_type.value == 'enterprise' %}
                                <div class="mb-3">
                                    <label class="form-label">AI Model</label>
                                    <select class="form-select">
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Standard)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (Enterprise)</option>
                                    </select>
                                    <div class="form-text">Enterprise users can access advanced AI models</div>
                                </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-end">
                                    {{ form.submit(class="btn btn-primary", value="Update AI Settings") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Base -->
                <div class="tab-pane fade" id="knowledge-base">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ t.knowledge_base }}</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addKnowledgeModal">
                                <i class="fas fa-plus me-2"></i>{{ t.add_knowledge }}
                            </button>
                        </div>
                        <div class="card-body">
                            {% if bot.knowledge_base %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>{{ t.title }}</th>
                                            <th>Type</th>
                                            <th>Added</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for kb in bot.knowledge_base %}
                                        <tr>
                                            <td>
                                                <h6 class="mb-1">{{ kb.title }}</h6>
                                                <small class="text-muted">{{ kb.content[:100] }}{% if kb.content|length > 100 %}...{% endif %}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark">{{ kb.file_type or 'text' }}</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ kb.created_at.strftime('%b %d, %Y') }}</small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="editKnowledge({{ kb.id }})" type="button">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteKnowledge({{ kb.id }})" type="button">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-book fa-3x text-muted mb-3"></i>
                                <h6>No knowledge base content yet</h6>
                                <p class="text-muted mb-3">Add documents, FAQs, or other content to help your bot provide better answers</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKnowledgeModal">
                                    <i class="fas fa-plus me-2"></i>{{ t.add_knowledge }}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Knowledge Modal -->
<div class="modal fade" id="addKnowledgeModal" tabindex="-1" aria-labelledby="addKnowledgeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="z-index: 1070;">
            <div class="modal-header">
                <h5 class="modal-title" id="addKnowledgeModalLabel">{{ t.add_knowledge }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1080;"></button>
            </div>
            <form method="POST" action="{{ url_for('dashboard.bot_settings', bot_id=bot.id) }}" enctype="multipart/form-data">
                {{ kb_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">{{ t.title }}</label>
                        {{ kb_form.title(class="form-control") }}
                        {% for error in kb_form.title.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">{{ t.content }}</label>
                        {{ kb_form.content(class="form-control", rows="8", placeholder="Enter content here or upload a file below...") }}
                        {% for error in kb_form.content.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                        <div class="form-text">Add information, FAQs, or instructions for your bot (optional if uploading file)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="file_upload" class="form-label">{{ t.upload_file }} (Optional)</label>
                        {{ kb_form.file_upload(class="form-control") }}
                        {% for error in kb_form.file_upload.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                        <div class="form-text">Upload a text file, PDF, or document</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="z-index: 1080;">{{ t.cancel }}</button>
                    {{ kb_form.submit(class="btn btn-primary", style="z-index: 1080;") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateTemperatureDisplay(value) {
    const helpText = document.getElementById('temperature-help');
    let description = '';
    
    if (value <= 0.3) {
        description = 'Very focused and deterministic responses';
    } else if (value <= 0.7) {
        description = 'Balanced between creativity and consistency';
    } else if (value <= 1.0) {
        description = 'Creative and varied responses';
    } else {
        description = 'Very creative and unpredictable responses';
    }
    
    helpText.textContent = `Controls response creativity and randomness (${value}) - ${description}`;
}

function copyWebhookUrl() {
    const webhookInput = document.querySelector('input[value*="webhook"]');
    webhookInput.select();
    document.execCommand('copy');
    
    // Show success message
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i>';
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.remove('btn-success');
    }, 2000);
}

function testBot() {
    // This would open a test chat interface
    alert('Test bot functionality would be implemented here');
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this bot? This action cannot be undone.')) {
        // Delete bot logic
        alert('Delete bot functionality would be implemented here');
    }
}

function editKnowledge(id) {
    // Edit knowledge base item
    alert('Edit knowledge functionality would be implemented here');
}

function deleteKnowledge(id) {
    if (confirm('Are you sure you want to delete this knowledge base item?')) {
        // Delete knowledge logic
        alert('Delete knowledge functionality would be implemented here');
    }
}

// Initialize temperature display
document.addEventListener('DOMContentLoaded', function() {
    const tempSlider = document.getElementById('temperature');
    if (tempSlider) {
        updateTemperatureDisplay(tempSlider.value);
    }
});
</script>
{% endblock %}
